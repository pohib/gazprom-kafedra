{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1 class="text-4xl font-bold text-center text-white mt-8 mb-4 p-4 bg-gradient-to-r from-blue-400 to-blue-500 rounded-lg shadow-lg"> 
    Наши партнёры 
</h1>

<div class="map-container relative w-full max-w-6xl h-[600px] mx-auto mt-8 bg-gradient-to-b from-gray-900/80 to-transparent rounded-2xl shadow-2xl border-4 border-blue-500/30 overflow-hidden">
    <div id="map-zoom-wrapper" class="w-full h-full transition-all duration-500 ease-out relative origin-center scale-marker draggable">
        <img alt="Map of Russia" class="w-full h-full" src="{% static 'img/russia.svg' %}" style="object-fit: contain;">
        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 33.5%; left: 56%; width: 55px; height: 55px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-lg drop-shadow-lg">5</div>
            <div class="city-label" style="top: 55px; left: 50%;">Новый Уренгой</div>
            <div class="popover map-popover">
                <strong>Новый Уренгой</strong><br>
                <span class="text-gray-600 font-normal">
                    ООО «Газпромнефть Заполярье», ООО «Газпром добыча Ямбург», АО «Ачимгаз», ООО «Ачим Девелопмент», ОАО «Севернефтегазпром»
                </span>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 87%; left: 57%; width: 32px; height: 32px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-sm drop-shadow-lg">2</div>
            <div class="city-label" style="top: 30px; left: 50%;">Иркутск</div>
            <div class="popover map-popover">
                <strong>Иркутск</strong><br>
                <span class="text-gray-600 font-normal">ООО «Газпром добыча Иркутск», ООО «Русгазбурение»</span>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 77%; left: 90%; width: 32px; height: 32px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-sm drop-shadow-lg">2</div>
            <div class="city-label" style="top: 40px; left: 50%;">Южно-Сахалинск</div>
            <div class="popover map-popover" style="left: -220px;">
                <strong>Южно-Сахалинск</strong><br>
                <span class="text-gray-600 font-normal">ООО «Газпром добыча шельф Южно-Сахалинск», ООО «Сахалинская Энергия»</span>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 45.6%; left: 14.3%; width: 20px; height: 20px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-xs drop-shadow-lg">1</div>
            <div class="city-label" style="top: 25px; left: 50%;">Москва</div>
            <div class="popover map-popover">
                <strong>ООО «Газпром бурение»</strong><br>
                <span class="text-gray-600 font-normal">бурение всех скважин ПАО Газпром</span>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 58%; left: 19.5%; width: 20px; height: 20px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-xs drop-shadow-lg">1</div>
            <div class="city-label" style="top: 25px; left: 50%;">Иннополис</div>
            <div class="popover map-popover">
                <strong>АНО ВО Университет Иннополис</strong><br>
                <span class="text-gray-600 font-normal">IT решения по задачам ПАО Газпром</span>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 73%; left: 44%; width: 20px; height: 20px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-xs drop-shadow-lg">1</div>
            <div class="city-label" style="top: 25px; left: 50%;">Томск</div>
            <div class="popover map-popover">
                <strong>ООО «Компания Ойлтим»</strong><br>
                <span class="text-gray-600 font-normal">современный сервис по исследованию скважин месторождений ПАО Газпром</span>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 70%; left: 20.4%; width: 20px; height: 20px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-xs drop-shadow-lg">1</div>
            <div class="city-label" style="top: 25px; left: 50%;">Оренбург</div>
            <div class="popover map-popover">
                <strong>ООО «Газпром добыча Оренбург»</strong>
            </div>
        </div>

        <div class="map-marker bg-gradient-to-r from-blue-500 to-blue-600 rounded-full absolute shadow-2xl hover:scale-110 transition-all duration-200 z-20" style="top: 48%; left: 39%; width: 20px; height: 20px; transform: translate(-50%, -50%);">
            <div class="absolute inset-0 flex items-center justify-center text-white font-bold text-xs drop-shadow-lg">1</div>
            <div class="city-label" style="top: 25px; left: 50%;">Надым</div>
            <div class="popover map-popover">
                <strong>ООО «Газпром добыча Надым»</strong>
            </div>
        </div>
    </div>

    <div class="absolute -translate-x-1/2 bottom-6 z-50 pointer-events-none w-full">
        <div class="zoom-control-container relative pointer-events-auto mx-auto bg-black/40 backdrop-blur-md rounded-3xl p-4 shadow-2xl border border-white/40">
            <input id="map-zoom" type="range" min="80" max="800" value="80" step="1" 
                class="w-full h-3 bg-transparent rounded-full appearance-none cursor-pointer block pointer-events-auto shadow-lg">
            <div id="zoom-value" class="absolute -top-16 py-2 rounded-2xl text-blue-600 font-bold text-lg shadow-2xl whitespace-nowrap transition-all duration-300 scale-0 origin-bottom z-10">
                100%
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
    const $zoom = $('#map-zoom');
    const $wrapper = $('#map-zoom-wrapper');
    const $zoomValue = $('#zoom-value');
    
    let scale = 1;
    let translateX = 0, translateY = 0;
    let isDragging = false;
    let lastX, lastY;
    let hoverTimeout, isHoveringMarker = false;
    let containerRect = {};
    let maxTranslateX = 0, minTranslateX = 0;
    let maxTranslateY = 0, minTranslateY = 0;

    function updateBoundaries() {
        const $container = $('.map-container');
        containerRect = $container[0].getBoundingClientRect();

        const baseMaxX = (containerRect.width * (1 - 1/scale)) / 2;
        const baseMaxY = (containerRect.height * (1 - 1/scale)) / 2;

        const expandX = 1.2;
        maxTranslateX = baseMaxX * expandX;
        minTranslateX = -maxTranslateX;

        maxTranslateY = baseMaxY;
        minTranslateY = -maxTranslateY;
    }

    function applyZoom(value) {
        scale = value / 100;
        
        updateBoundaries();
        translateX = Math.max(minTranslateX, Math.min(maxTranslateX, translateX));
        translateY = Math.max(minTranslateY, Math.min(maxTranslateY, translateY));

        const markerScale = Math.max(0.35, Math.min(1.1, 1 / Math.sqrt(scale) * 0.98));
        const labelScale = Math.max(0.45, Math.min(1.15, 1 / Math.sqrt(scale) * 1.02));
        const popoverScale = Math.max(0.4, Math.min(1.1, 1 / Math.sqrt(scale) * 0.95));

        if (scale > 1) {
            $wrapper.addClass('draggable');
        } else {
            $wrapper.removeClass('draggable');
            translateX = 0;
            translateY = 0;
        }

        
        $wrapper.css({
            'transform': `scale(${scale}) translate(${translateX}px, ${translateY}px)`
        });
        
        $wrapper[0].style.setProperty('--marker-scale', markerScale);
        $wrapper[0].style.setProperty('--label-scale', labelScale);
        $wrapper[0].style.setProperty('--popover-scale', popoverScale);
        
        const displayValue = Math.round(((value - 80) / (800 - 80)) * 100);

        $zoomValue.text(displayValue + '%');

        const $container = $zoom.closest('.zoom-control-container');
        const containerRect = $container[0].getBoundingClientRect();
        const sliderRect = $zoom[0].getBoundingClientRect();
        const min = parseInt($zoom[0].min);
        const max = parseInt($zoom[0].max);
        const range = max - min;
        const percent = (value - min) / range;
        
        const sliderLeftOffset = sliderRect.left - containerRect.left;
        const thumbLeftInSlider = percent * (sliderRect.width - 24);
        const thumbLeftInContainer = sliderLeftOffset + thumbLeftInSlider + 12;
        
        $zoomValue.css({
            'left': thumbLeftInContainer + 'px',
            'transform': 'translateX(-50%) scale(1)'
        });
    }

    applyZoom(80);

    updateBoundaries();

    setTimeout(() => {
        $zoomValue.css('transform', 'translateX(-50%) scale(0)');
    }, 1500);

    $zoom.on('input', function () {
        const val = parseInt(this.value);
        applyZoom(val);
        clearTimeout(window.zoomLabelTimeout);
        window.zoomLabelTimeout = setTimeout(() => {
            $zoomValue.css('transform', 'translateX(-50%) scale(0)');
        }, 1500);
    });

    const mapContainer = $('.map-container')[0];
    
    mapContainer.addEventListener('mousedown', startDrag, { passive: false });
    mapContainer.addEventListener('touchstart', startDrag, { passive: false });
    
    document.addEventListener('mousemove', drag, { passive: false });
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('mouseup', endDrag, { passive: false });
    document.addEventListener('touchend', endDrag, { passive: false });
    
    function startDrag(e) {
        if (e.target.closest('.zoom-control-container')) return;
        if (scale <= 1.1) return;
        isDragging = true;
        $wrapper.addClass('dragging');
        
        lastX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
        lastY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
        
        updateBoundaries();
        
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging || scale <= 1.2) return;
        
        const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
        const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
        
        const deltaX = clientX - lastX;
        const deltaY = clientY - lastY;

        translateX = Math.max(minTranslateX, Math.min(maxTranslateX, translateX + deltaX));
        translateY = Math.max(minTranslateY, Math.min(maxTranslateY, translateY + deltaY));
        
        $wrapper.css({
            'transform': `scale(${scale}) translate(${translateX}px, ${translateY}px)`
        });
        
        lastX = clientX;
        lastY = clientY;
        e.preventDefault();
    }
    
    function endDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        $wrapper.removeClass('dragging');

        const clampX = Math.max(minTranslateX, Math.min(maxTranslateX, translateX));
        const clampY = Math.max(minTranslateY, Math.min(maxTranslateY, translateY));
        
        if (Math.abs(translateX - clampX) > 0.5 || Math.abs(translateY - clampY) > 0.5) {
            $wrapper.css({
                'transition': 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                'transform': `scale(${scale}) translate(${clampX}px, ${clampY}px)`
            });
            
            setTimeout(() => {
                translateX = clampX;
                translateY = clampY;
                $wrapper.css('transition', '');
            }, 300);
        }
    }

    $wrapper.on('wheel', function(e) {
        e.preventDefault();
        
        const zoomStep = 25;
        const currentValue = parseInt($zoom.val());
        
        let newValue;
        if (e.deltaY < 0) {
            newValue = Math.min(800, currentValue + zoomStep);
        } else {
            newValue = Math.max(80, currentValue - zoomStep);
        }
        
        $zoom.val(newValue);
        applyZoom(newValue);
    });

    $('.map-marker, .city-label').hover(
        function() {
            clearTimeout(hoverTimeout); 
            isHoveringMarker = true;
            
            const $marker = $(this).closest('.map-marker');
            const $label = $marker.find('.city-label');
            const $popover = $marker.find('.popover.map-popover');
            
            $marker.css('z-index', '40');
            $label.css('z-index', '41');
            $popover.css('z-index', '49');
            
            $popover.stop(true, true).css('visibility', 'visible').fadeTo(250, 1);
        },
        function() {
            isHoveringMarker = false;
            hoverTimeout = setTimeout(() => {
                if (!isHoveringMarker) {
                    const $marker = $(this).closest('.map-marker');
                    const $label = $marker.find('.city-label');
                    const $popover = $marker.find('.popover.map-popover');

                    $marker.css('z-index', '20');
                    $label.css('z-index', '40');
                    $popover.css('z-index', '48');
                    
                    $popover.stop(true, true).fadeTo(200, 0, function() {
                        $(this).css('visibility', 'hidden');
                    });
                }
            }, 50);
        }
    );
});
</script>
{% endblock %}

