{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Новости кафедры{% endblock %}

{% block content %}

<h1 class="text-4xl font-bold text-center text-white mt-8 mb-4 p-4 bg-gradient-to-r from-blue-400 to-blue-500 rounded-lg shadow-lg animate__animated animate__fadeInDown">
    Новости кафедры
</h1>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {% for post in posts %}
    <div class="bg-white rounded shadow p-4 news-card cursor-pointer flex flex-col" onclick="openModal({{ forloop.counter0 }})" style="min-height: 400px;">
      
      {% if post.images.all %}
        {% with img=post.images.all.0 %}
          <div class="mb-4 h-48 overflow-hidden rounded">
            {% if '%' in img.crop_position %}
              <img src="{{ img.image_url }}" 
                   alt="News Image" 
                   class="w-full h-full object-cover rounded"
                   style="object-position: center {{ img.crop_position|default:'center' }};">
            {% else %}
              <img src="{{ img.image_url }}" 
                   alt="News Image" 
                   class="w-full h-full object-cover rounded"
                   style="object-position: {{ img.crop_position|default:'center' }};">
            {% endif %}
          </div>
        {% endwith %}
      {% else %}
        <div class="mb-4 h-48 flex items-center justify-center bg-gray-100 rounded">
          <span class="text-gray-400">Нет изображения</span>
        </div>
      {% endif %}
      
      <h2 class="text-xl font-semibold underline-title">
        {{ post.title|truncatechars:200 }}
      </h2>
      <p class="text-gray-700 mt-2 flex-grow">{{ post.body|truncatechars:300 }}</p>

      <div class="text-gray-500 text-sm mt-2 flex items-center justify-between">
        <div class="flex items-center">
          <i class="fas fa-eye mr-1"></i>
          <span>{{ post.views }}</span>
        </div>
        <span>{{ post.date|date:"d.m.Y" }}</span>
      </div>
    </div>
  {% empty %}
    <p>Пока нет новостей.</p>
  {% endfor %}
</div>

<div id="modal"
     class="hidden fixed inset-x-0 top-20 bottom-0 bg-gray-900 bg-opacity-75 flex items-start justify-center z-50 p-4 overflow-auto">
  <div class="bg-white rounded-lg shadow-lg p-6 relative w-full max-w-full max-h-full overflow-auto">
    <button onclick="closeModal()" aria-label="Close"
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 z-10">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg">
        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
      </svg>
    </button>
    <h2 id="modal-title" class="text-2xl font-bold mb-4 text-center underline-title"></h2>
    <div class="text-gray-500 text-sm mb-4 flex items-center justify-between">
      <div class="flex items-center">
        <i class="fas fa-eye mr-1"></i>
        <span id="modal-views"></span>
      </div>
      <span id="modal-date"></span>
    </div>
    <div id="modal-body" class="text-gray-700 mb-4 whitespace-pre-line leading-relaxed"></div>
    <div id="modal-images" class="modal-image-container flex space-x-2 overflow-x-auto"></div>
  </div>
  <div id="modal-image-full" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-60 cursor-zoom-out" onclick="closeFullImage()">
  
  <button id="prevImageBtn" 
          onclick="event.stopPropagation(); changeImage(-1);" 
          class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-3xl font-bold z-70 bg-black bg-opacity-50 rounded-full px-3">
    ‹
  </button>
  
  <img id="modal-image-full-img" src="" alt="Full Image" class="max-w-full max-h-full object-contain">
  
  <button id="nextImageBtn" 
          onclick="event.stopPropagation(); changeImage(1);" 
          class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-3xl font-bold z-70 bg-black bg-opacity-50 rounded-full px-3">
    ›
  </button>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    
let currentPostIndex = 0;
const postsData = [
  {% for post in posts %}
  {
    title: "{{ post.title|escapejs }}",
    body: `{{ post.body|escapejs }}`,
    views: {{ post.views }},
    date: "{{ post.date|date:'U' }}",
    images: [
      {% for img in post.images.all %}
        "{% with img.image_url|escapejs as url_escaped %}{{ url_escaped|safe|replace:'&amp;,&' }}{% endwith %}"{% if not forloop.last %},{% endif %}
      {% empty %}
      {% endfor %}
    ]
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];
 
function openModal(index) {
    currentPostIndex = index;
    window.scrollTo({ top: 0, behavior: 'smooth' });
    const modal = document.getElementById('modal');
    const post = postsData[index];
    if (!post) return;

    document.getElementById('modal-title').textContent = post.title;
    document.getElementById('modal-body').innerHTML = post.body;
    document.getElementById('modal-views').textContent = post.views;
    document.getElementById('modal-date').textContent =
        new Date(post.date * 1000).toLocaleDateString('ru-RU');

    const imagesContainer = document.getElementById('modal-images');
    imagesContainer.innerHTML = '';
    post.images.forEach((src, idx) => {
        if (src && src.trim() !== '') {
            const img = document.createElement('img');
            img.src = src;
            img.alt = 'News Image';
            img.className = 'rounded max-h-48 cursor-zoom-in';
            img.onclick = (e) => {
            e.stopPropagation();
            openFullImage(src, idx);
            };
            imagesContainer.appendChild(img);
        }
    });


    modal.classList.remove('hidden');
    document.body.classList.add('no-scroll');
}

function closeModal() {
    const modal = document.getElementById('modal');
    modal.classList.add('hidden');
    document.body.classList.remove('no-scroll');
}

document.addEventListener('keydown', e => {
    if (e.key === "Escape") closeModal();
});

document.getElementById('modal').addEventListener('click', e => {
    if (e.target.id === 'modal') closeModal();
});


function openFullImage(src, index = 0) {
  const fullImageModal = document.getElementById('modal-image-full');
  const fullImage = document.getElementById('modal-image-full-img');
  fullImage.src = src;  
  fullImage.style.transform = 'scale(0.7)';
  fullImageModal.classList.remove('hidden');
  document.body.classList.add('no-scroll');
  currentFullImageIndex = index;
}

function closeFullImage() {
  const fullImageModal = document.getElementById('modal-image-full');
  fullImageModal.classList.add('hidden');
  document.body.classList.remove('no-scroll');
}

function changeImage(direction) {
    if (!postsData[currentPostIndex]) return;
    const images = postsData[currentPostIndex].images;
    currentFullImageIndex += direction;
    if (currentFullImageIndex < 0) currentFullImageIndex = images.length - 1;
    if (currentFullImageIndex >= images.length) currentFullImageIndex = 0;

    const fullImage = document.getElementById('modal-image-full-img');
    fullImage.src = images[currentFullImageIndex];
}
</script>
{% endblock %}
